<!DOCTYPE html>

<head>
  <title>Games Rating: 2015 - 2019</title>
  <meta charset="utf-8">
  <style>
    /* <!-- define CSS rules --> */
    div {
      text-align: center;
      width: 612px;
      font-size: 20px;
      opacity: 0;
    }
  </style>
</head>

<body>
  <script type="text/javascript" src="../lib/d3.v5.min.js"></script>
  <script type="text/javascript" src="../lib/d3-dsv.min.js"></script>

  <!-- Example hiding an element -->
  <!-- <g id="" style"display:none;" /> -->

  <!-- Example of styling an element -->
  <!-- svg_element.style()-->

  <script>
    // define the dimensions and margins for the line chart
    // Use the Margin Convention referenced in the HW document to layout your graph
    margin = ({top: 45, right: 45, bottom: 45, left: 90});
    const width = 477;
    const height = 250;

    // define the dimensions and margins for the bar chart
    // For now, same as line chart

    // append svg element to the body of the page
    // set dimensions and position of the svg element
    let svg = d3
      .select("body")
      .append("svg")
      .attr("id", "line_chart")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
      .append("g")
      .attr("id", "container")
      .attr("transform",
        "translate(" + margin.left + "," + margin.top + ")");

    // Fetch the data
	  var pathToCsv = "average-rating.csv";


    d3.dsv(",", pathToCsv, function (d) {
      return {
        // format data attributes if required
        "name" : d.name, "year" : d.year, "average_rating" : d.average_rating,
        "users_rated" : d.users_rated
      }
    }).then(function (data) {
      console.log(data); // you should see the data in your browser's developer tools console

      var sumstat = d3.nest() // nest - group calculation per level of factor
            .key(function(d) {return Math.floor(d.average_rating)})
            .key(function(d) {return d.year; })
            .entries(data);

      var linegraph_data = [['0'], ...sumstat.map(d => [d.key, ...d.values]).sort((a, b) => a[0] - b[0])]
      console.log(sumstat)
      console.log(linegraph_data)
      // Properly Format the data
      function populate_ratings(year, arr) {
        let tmp = arr.map(d => d[0])
        if (tmp.includes(year)) {
          let ind = tmp.indexOf(year);
          return arr[ind][1];
        } else {
          return 0
        }
      }
      const years = ["2015", "2016", "2017", "2018", "2019"]
      var final_data = linegraph_data.map(d => [d[0], ...years.map(y => populate_ratings(y, d.slice(1).map(d => [d.key, d.values.length])))])
      console.log("here")
      console.log(final_data)
      // Scale x-axis
      var x_max = d3.max(d3.max(final_data.map(d => d.slice(0,1))))
      // console.log(x_max)
      var xScale = d3.scaleLinear()
          .domain([0, x_max])
          .range([0,width])

      // Scale y-axis
      var y_max = d3.max(d3.max(final_data.map(d => d.slice(1))))
      // console.log(y_max)
      var yScale = d3.scaleLinear()
          .domain([0, y_max])
          .range([height, 0])

        // Add title
        svg.append("text")
          .attr("x", width/2)
          .attr("y", -margin.top/4)
          .attr("id", "line_chart_title")
          .attr("text-anchor", "middle")
          .style("font-family", "garamond")
          .style("font-size", 24)
          .text("Board games by Rating 2015-2019");

        // Add credit
        svg.append("text")
          .attr("x", width/2)
          .attr("y", margin.top/4)
          .attr("id", "credit")
          .attr("text-anchor", "middle")
          .style("font-family", "helvetica")
          .style("font-size", 14)
          .text("mhill313");

        // Create the x-axis
        var x_axis = svg.append("g")
              .attr("id", "x-axis-lines")
              .attr("transform", "translate(0,"+height + ")")
              .call(d3.axisBottom(xScale));

        // Create the y-axis
        var y_axis = svg.append("g")
              .attr("id", "y-axis-lines")
              .call(d3.axisLeft(yScale));

        // Label the x-axis
        svg.append("text")
              .attr("x", width/2)
              .attr("y", height+3*(margin.top+margin.bottom)/8)
              .attr("text-anchor", "middle")
              .style("font-family", "helvetica")
              .style("font-size", 14)
              .text("Rating");

        // Label the y-axis
        svg.append("text")
              .attr("text-anchor", "middle")
              .attr("transform", "translate("+5*(-margin.left)/8+","+height/2+")rotate(-90)")
              .style("font-family", "helvetica")
              .style("font-size", 14)
              .text("Count");

      // Create lines, circles, and legend
      var line = d3.line()
          .x(d => xScale(d[0]))
          .y(d => yScale(d[1]));

      var line_plot = svg.append("g")
            .attr("id", "lines");

      var circles = svg.append("g")
            .attr("id", "circles");

      var legend = svg.append("g")
            .attr("id", "legend");

      var colorscale = d3.scaleOrdinal(d3.schemeCategory10);

      // console.log(final_data)
      for (var i = 1; i <= years.length; i= i+1) {
        
        var cur_data = final_data.map( d => Object.values(d)).map(d => [d[0], d[i], years[i-1]])
        // console.log(cur_data);
        // Creates Lines
        line_plot.append("path")
            .datum(cur_data)
            .attr("class", "line")
            .attr("d", line)
            .style("fill", "none")
            .style("stroke", colorscale(i-1))
            .style("stroke-width", "2");

        // Create Dots
        circles.append("g")
            .selectAll("dot")
            .data(cur_data)
            .enter()
            .append("circle")
            .attr("cx", function (d) { return xScale(d[0]); } )
            .attr("cy", function (d) { return yScale(d[1]); } )
            .attr("r", 4)
            .style("fill", colorscale(i-1))
            .on("mouseover", mouseover)
            .on("mouseout", mouseout);

        // Create Legend
        legend.append("text")
            .text(years[i-1])
            .attr("x", width-30)
            .attr("y", i*20)
            .attr("text-anchor", "start")
            .attr("dominant-baseline", "middle")
            .style("font-family", "helvetica")
            .style("font-size", 14);

        legend.append("circle")
            .attr("cx", width-40)
            .attr("cy", i*20)
            .attr("r", 4)
            .style("fill", colorscale(i-1));
      }

      function mouseover(d) {
          new_node = d3.select(this);
          new_node.transition()
              .duration('50')
              .attr("r", 8);
          console.log(new_node);
          console.log(d);

          if (d[1] > 0) {
              // remove any previous bar chart
              create_bar_chart(d[2], d[0]);

              bar_graph = d3.select("div#bar_chart_title")
                  .style("opacity", "1")
                  .text("Top 5 Most Rated Games of "+d[2]+" with Rating "+d[0]);

              bar_graph = d3.select("svg#bar_chart").select("g")
                  .style("opacity", "1");
          }
          return
      }

      function mouseout(d) {
          new_node = d3.select(this);
          new_node.transition()
          new_node.transition()
              .duration('50')
              .attr("r", 4);

          s_div = d3.select("div#bar_chart_title")
              .style("opacity", "0");

          s_bar_graph = d3.select("svg#bar_chart").select("g")
              .style("opacity", "0");
          // console.log(s_bar_graph)
          remove_bar_chart();

          return
      }




      /* Create bar plot using data from csv */
      // Use sumstat
      // let rating = "4";
      // let year = "2015";
      
      function bar_chart_subselection(arr, y, r) {
        var tmp_1 = arr.map(d => d.key);
        if (tmp_1.includes(r)) {
          ind1 = tmp_1.indexOf(r);
          var new_arr = arr[ind1].values
          var tmp_2 = new_arr.map(d => d.key)
          if(tmp_2.includes(y)) {
            ind2 = tmp_2.indexOf(y)
            return new_arr[ind2].values
          }
        } 

        return null
      }

      function create_bar_chart(year, rating) {

        var bar_stats = bar_chart_subselection(sumstat, year, rating)

        // Does not run if selection does not come up with any games.
        if (!(bar_stats == null)) {
            // Format the data to work with
            var final_bar_data = bar_stats.map(d => [d.name, d.users_rated]).sort((a, b) => b[1] - a[1])
            if (final_bar_data.length > 5) {
              final_bar_data = final_bar_data.slice(0,5)
            }
            console.log(final_bar_data);

            var padding = 15;

            // Add chart title
            d3.select("body").append("div")
              .attr("id", "bar_chart_title")
              .attr("text-anchor", "middle")
              .style("font-family", "garamond")
              .style("font-size", 24)
              .text("Top 5 Most Rated Games of "+year+" with Rating "+rating)

            // append svg element to the body of the page
            var bar_svg = d3.select("body").append("svg")
              // set the id, dimensions and position of the svg element 	
              .attr("width", width+margin.left+margin.right)
              .attr("height", height+margin.top+margin.bottom)
              .attr("id", "bar_chart")
              // .attr("opacity", "0")
              .append("g")
              .attr("id", "container_2")
              .attr("opacity", "0");
        
            // create scales x & y for X and Y axis and set their ranges
            var max_value = d3.max(final_bar_data.map(x => parseInt(x[1])))
            console.log(max_value)

            var x = d3.scaleLinear()
                  .domain([0,max_value])
                  .range([0,width]);

            var y = d3.scaleBand()
                  .domain(final_bar_data.map(x => x[0].slice(0,10)))
                  .range([0,height]);

            // Add the X Axis
            bar_svg.append("g")
                .attr("id", "x-axis-bars")
                .attr("transform", "translate("+margin.left+","+height+")")
                .call(d3.axisBottom().tickSize(1)
                  .scale(x));

            // Add the text label for X Axis
            bar_svg.append("text")
                .attr("id", "bar_x_axis_label")
                .attr("x", width/2+margin.left)
                .attr("y", height+margin.top)
                .text("Number of users")
                .style("text-anchor", "middle")
                .style("font-family", "helvetica")
                .style("font-size", 14);

            // Add the Y Axis
            bar_svg.append("g")
                .attr("id", "y-axis-bars")
                .attr("transform", "translate("+margin.left+",0)")
                .call(d3.axisLeft().tickSize(3)
                  .scale(y));

            // Add the text label for Y axis
            bar_svg.append("text")
                .attr("id", "bar_y_axis_label")
                .attr("transform", "translate("+(margin.left)/4+","+height/2+")rotate(-90)")
                .text("Games")
                .style("text-anchor", "middle")
                .style("font-family", "helvetica")
                .style("font-size", 14);

            // Add gridlines
            bar_svg.selectAll("line.vertical-grid")
                .data(x.ticks(5))
                .enter()
                .append("line")
                .attr("x1", d => x(d)+margin.left)
                .attr("y1", 0)
                .attr("x2", d => x(d)+margin.left)
                .attr("y2", height)
                .style("stroke", "black")
                .style("stroke-width", 1);

            // Add bars to svg - create new elements based on your data
            bar_svg.append("g")
                .attr("id", "bars")
                .attr("transform", function(d) {return "translate(" + margin.left + ","+margin.top+")";})
                .selectAll("rect")
                .data(final_bar_data)
                .enter()
                .append("rect")
                .attr("x", 0)
                .attr("y", (d, i) => (i-1)*(height/ final_bar_data.length)+padding)
                .attr("width", d => d[1]*width/max_value)
                .attr("height", height / final_bar_data.length - padding)
                .attr("fill", "#EC7A08");;

          }
      }

      function remove_bar_chart() {
        var bar_svg = d3.select("svg#bar_chart");
              
            // Delete the X Axis
            bar_svg.select("g#x-axis-bars").remove();
            bar_svg.select("text#bar_x_axis_label").remove();

            // Delete the Y Axis
            bar_svg.select("g#y-axis-bars").remove()
            bar_svg.select("text#bar_y_axis_label").remove();

            // Delete the gridlines
            bar_svg.select("line.vertical-grid").remove();

            // Delete bars from svg
            bar_svg.select("g#bars").exit().remove();

            bar_svg.remove();

            d3.select("div#bar_chart_title").remove();
      }

    }).catch(function (error) {
      console.log(error);
    });


  </script>

</body>
